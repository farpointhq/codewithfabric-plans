<link rel="stylesheet" href="../stylesheets/extra.css">
<div class="diagram" style="max-width:800px">
  <div class="diagram-title" style="font-size:16px;font-weight:700;text-align:center;margin-bottom:20px;color:#a5b4fc">Webhook Handler Changes</div>

  <!-- Incoming event -->
  <div style="text-align:center;margin-bottom:12px">
    <div style="display:inline-block;background:#1f2937;border:1px solid #6b7280;padding:8px 24px;border-radius:8px">
      <div style="color:#d1d5db;font-size:11px;font-weight:600">STRIPE WEBHOOK EVENT</div>
      <div style="color:#9ca3af;font-size:12px;margin-top:2px">checkout.session.completed / invoice.paid / subscription.deleted</div>
    </div>
  </div>

  <!-- Decision point -->
  <div style="text-align:center;margin-bottom:12px">
    <div style="width:2px;height:16px;background:#374151;margin:0 auto"></div>
    <div style="display:inline-block;background:#78350f;border:1px solid #d97706;padding:8px 20px;border-radius:8px;transform:rotate(0deg)">
      <div style="color:#fcd34d;font-size:12px;font-weight:600">metadata.forMemberId exists?</div>
    </div>
    <div style="display:flex;justify-content:center;gap:200px;margin-top:8px">
      <div style="color:#4ade80;font-size:11px;font-weight:600">YES</div>
      <div style="color:#f87171;font-size:11px;font-weight:600">NO</div>
    </div>
  </div>

  <!-- Two paths -->
  <div style="display:flex;gap:16px">
    <!-- New: Per-member path -->
    <div class="diagram-box renderer" style="flex:1">
      <div class="diagram-box-title">NEW: PER-MEMBER PATH</div>
      <div class="diagram-steps">
        <div class="diagram-step">
          <span class="diagram-step-num">1</span>
          <span class="diagram-step-text">Find TeamMember by <code class="diagram-step-code">forMemberId</code></span>
        </div>
        <div class="diagram-connector"></div>
        <div class="diagram-step">
          <span class="diagram-step-num">2</span>
          <span class="diagram-step-text"><strong>checkout.completed</strong>: Set isUnlimited=true, store subId</span>
        </div>
        <div class="diagram-connector"></div>
        <div class="diagram-step">
          <span class="diagram-step-num">3</span>
          <span class="diagram-step-text"><strong>invoice.paid</strong>: Extend unlimited period</span>
        </div>
        <div class="diagram-connector"></div>
        <div class="diagram-step">
          <span class="diagram-step-num">4</span>
          <span class="diagram-step-text"><strong>sub.deleted</strong>: Set isUnlimited=false, clear subId</span>
        </div>
      </div>
    </div>

    <!-- Existing: Team path -->
    <div class="diagram-box main" style="flex:1">
      <div class="diagram-box-title">EXISTING: TEAM PATH (unchanged)</div>
      <div class="diagram-steps">
        <div class="diagram-step">
          <span class="diagram-step-num">1</span>
          <span class="diagram-step-text">Find Team by stripeSubscriptionId</span>
        </div>
        <div class="diagram-connector"></div>
        <div class="diagram-step">
          <span class="diagram-step-num">2</span>
          <span class="diagram-step-text"><strong>checkout.completed</strong>: Update Team plan</span>
        </div>
        <div class="diagram-connector"></div>
        <div class="diagram-step">
          <span class="diagram-step-num">3</span>
          <span class="diagram-step-text"><strong>invoice.paid</strong>: Add credits to Team balance</span>
        </div>
        <div class="diagram-connector"></div>
        <div class="diagram-step">
          <span class="diagram-step-num">4</span>
          <span class="diagram-step-text"><strong>sub.deleted</strong>: Cancel Team subscription</span>
        </div>
      </div>
    </div>
  </div>
</div>
